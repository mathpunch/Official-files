<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sea Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
 --bg:#020617;
 --glass:rgba(15,23,42,.6);
 --accent:#4fd1c5;
 --text:#e5e7eb;
}
*{box-sizing:border-box;font-family:Segoe UI;margin:0}
body{display:flex;height:100vh;background:linear-gradient(#030d18,#06111f);color:var(--text);overflow:hidden}

#login{position:fixed;inset:0;background:#020617;display:flex;align-items:center;justify-content:center;z-index:10}
#loginBox{background:var(--glass);backdrop-filter:blur(10px);padding:30px;border-radius:16px;width:320px;text-align:center}
#loginBox input{width:100%;padding:12px;margin:8px 0;border:none;border-radius:10px;background:#020617;color:white}
#loginBox button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:10px;background:var(--accent);font-weight:bold;cursor:pointer}

#channels,#members{width:220px;margin:10px;padding:15px;background:var(--glass);border-radius:16px;overflow-y:auto}
#chat{flex:1;margin:10px;background:var(--glass);border-radius:16px;display:flex;flex-direction:column}
#messages{flex:1;padding:16px;overflow-y:auto}
.msg{display:flex;margin-bottom:14px}
.msg img{width:36px;height:36px;border-radius:50%;margin-right:10px}
#inputBar{display:flex;padding:12px;border-top:1px solid rgba(255,255,255,.1)}
#msgInput{flex:1;padding:10px;border:none;border-radius:10px;background:#020617;color:white}
#inputBar button{padding:10px 16px;border:none;border-radius:10px;background:var(--accent);cursor:pointer}
.logout{position:absolute;top:10px;right:10px;cursor:pointer}
</style>
</head>
<body>

<div id="login">
 <div id="loginBox">
  <h2>Sea Chat</h2>
  <input id="nameInput" placeholder="Username">
  <input id="passInput" type="password" placeholder="Password">
  <input id="pfpInput" placeholder="Avatar URL (optional)">
  <button onclick="loginOrRegister()">Login / Register</button>
 </div>
</div>

<div class="logout" onclick="logout()">Logout</div>

<div id="channels"><b>Channels</b><div onclick="openChannel()"># general</div></div>

<div id="chat">
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" placeholder="Message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<div id="members">
  <b>ONLINE <span id="onlineCount">0</span></b>
  <div id="memberList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyCKD8pikFOPzw7kuLsntQbCoza6uXVn5D8",
 projectId:"banning-users"
});
const db = getFirestore(app);

let user=null, profile=null, heartbeatInterval=null;
const PRESENCE_TIMEOUT=60000;

window.onload=()=>{
 const saved=JSON.parse(localStorage.getItem("account"));
 if(saved) autoLogin(saved);
};

window.loginOrRegister=async()=>{
 const name=nameInput.value.trim();
 const pass=passInput.value.trim();
 if(name.length<2||pass.length<2) return alert("Too short");

 const ref=doc(db,"users",name);
 const snap=await getDoc(ref);

 if(!snap.exists()){
   await setDoc(ref,{
     name:name,
     password:pass,
     avatar:pfpInput.value || "https://i.imgur.com/6VBx3io.png"
   });
 }

 const finalSnap=await getDoc(ref);
 if(finalSnap.data().password!==pass) return alert("Wrong password");

 localStorage.setItem("account",JSON.stringify({name,pass}));
 autoLogin({name,pass});
};

async function autoLogin(acc){
 user=acc.name;
 const snap=await getDoc(doc(db,"users",user));
 profile=snap.data();
 login.style.display="none";
 startPresence();
 listenMembers();
 openChannel();
}

window.logout=async()=>{
 if(user) await deleteDoc(doc(db,"presence",user));
 localStorage.removeItem("account");
 location.reload();
};

window.sendMessage=async()=>{
 if(!msgInput.value) return;
 await addDoc(collection(db,"channels","general","messages"),{
   user:user,
   message:msgInput.value,
   createdAt:serverTimestamp(),
   avatar:profile.avatar
 });
 msgInput.value="";
};
msgInput.addEventListener("keydown",e=>{if(e.key==="Enter")sendMessage()});

window.openChannel=()=>{
 const q=query(collection(db,"channels","general","messages"),orderBy("createdAt"));
 onSnapshot(q,snap=>{
   messages.innerHTML="";
   snap.forEach(d=>{
     const m=d.data();
     messages.innerHTML+=`
     <div class="msg">
       <img src="${m.avatar}">
       <div><b>${m.user}</b><div>${m.message}</div></div>
     </div>`;
   });
   messages.scrollTop=messages.scrollHeight;
 });
};

function startPresence(){
 const ref = doc(db,"presence",user);
 const writePresence=()=>setDoc(ref,{name:user,avatar:profile.avatar,lastSeen:serverTimestamp()});
 writePresence();
 heartbeatInterval=setInterval(writePresence,20000);
 window.addEventListener("beforeunload",()=>deleteDoc(ref));
}

function listenMembers(){
 onSnapshot(collection(db,"presence"), snap=>{
   memberList.innerHTML="";
   const now=Date.now();
   let onlineUsers=[];

   snap.forEach(docSnap=>{
     const data=docSnap.data();
     if(!data.lastSeen) return;
     const lastSeen=data.lastSeen.toDate().getTime();
     if(now-lastSeen>PRESENCE_TIMEOUT) return;
     onlineUsers.push(data);
   });

   onlineCount.innerText=onlineUsers.length;

   onlineUsers.forEach(u=>{
     const div=document.createElement("div");
     div.style.display="flex";
     div.style.alignItems="center";
     div.style.gap="8px";
     div.style.margin="6px 0";
     div.innerHTML=`
       <img src="${u.avatar}" style="width:28px;height:28px;border-radius:50%">
       <span>${u.name}${u.name===user?" (You)":""}</span>
     `;
     memberList.appendChild(div);
   });
 });
}
</script>

</body>
</html>
